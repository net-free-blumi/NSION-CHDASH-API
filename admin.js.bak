// ××¢×¨×›×ª × ×™×”×•×œ ××•×¦×¨×™× - ×’×•×œ×“×™×¡
class ProductManager {
    constructor() {
        this.products = {};
        this.categories = {
            "kitchen": "××•×¦×¨×™ ××˜×‘×—",
            "bakery": "×§×•× ×“×™×˜×•×¨×™×™×”",
            "fruits": "×¤×™×¨×•×ª",
            "sushi": "×¡×•×©×™",
            "amar": "×§×•× ×“×™×˜×•×¨×™×™×” ×¢××¨",
            "kitchenProducts": "××˜×‘×— ××•×¡×˜×¤×”",
            "online": "××•× ×œ×™×™×Ÿ",
            "warehouse": "××—×¡×Ÿ",
            "sizes": "××•×¦×¨×™ ×’×“×œ×™×",
            "quantities": "××•×¦×¨×™ ×›××•×ª",
        };
        this.init();
    }

    async init() {
        try {
            // ×‘×“×™×§×ª ×—×™×‘×•×¨ ×œ×©×¨×ª
            const response = await fetch(`${config.getApiBaseUrl()}/api/stats`);
            if (!response.ok) {
                throw new Error('×©×’×™××” ×‘×”×ª×—×‘×¨×•×ª ×œ×©×¨×ª');
            }
            await this.loadProducts();
            this.updateStats();
            window.productManager = this;
        } catch (error) {
            console.warn('Init failed:', error);
            this.showNotification('âŒ ×©×’×™××” ×‘×”×ª×—×‘×¨×•×ª ×œ×©×¨×ª', 'error');
        }
    }

    async saveAllToServer() {
        try {
            const response = await fetch(`${config.getApiBaseUrl()}/api/products/save`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    products: this.products,
                    categories: this.categories,
                    timestamp: new Date().toISOString()
                })
            });

            if (!response.ok) {
                throw new Error('×©×’×™××” ×‘×©××™×¨×ª ×”××•×¦×¨×™×');
            }

            const result = await response.json();
            if (!result.success) {
                throw new Error(result.error || '×©×’×™××” ×œ× ×™×“×•×¢×”');
            }

            console.log('âœ… ×”××•×¦×¨×™× × ×©××¨×• ×‘×”×¦×œ×—×”:', result);
            return true;
        } catch (error) {
            console.error('×©×’×™××” ×‘×©××™×¨×”:', error);
            this.showNotification('âŒ ×©×’×™××” ×‘×©××™×¨×ª ×”××•×¦×¨×™×: ' + error.message, 'error');
            throw error;
        }
    }
            
            this.showNotification('âŒ ×©×’×™××” ×‘×©××™×¨×ª ×”××•×¦×¨×™×: ' + e.message, 'error');
            throw e;
        }
    }
    // ×‘×¡×™×¡ URL ×œ×©×¨×ª
    static getApiBaseUrl() {
        return window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:5000'
            : 'https://nsaion-golsya.netlify.app';
    }

    // ×©××™×¨×” ××™×™×“×™×ª ×œ×©×¨×ª ××—×¨×™ ×›×œ ×©×™× ×•×™ ×¢× × ×™×”×•×œ ×©×’×™××•×ª ××©×•×¤×¨
    async saveAllToServer(retryCount = 0) {
        const MAX_RETRIES = 2;
        try {
            // ×©××™×¨×ª ×›×œ ×”××•×¦×¨×™× ×‘×‘×ª ××—×ª
            const response = await fetch(`${ProductManager.getApiBaseUrl()}/api/products/save`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    products: this.products,
                    categories: this.categories,
                    timestamp: new Date().toISOString()
                })
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error || '×©×’×™××” ×‘×©××™×¨×ª ×”××•×¦×¨×™×');
            }

            const result = await response.json();
            console.log('âœ… ×›×œ ×”××•×¦×¨×™× × ×©××¨×• ×‘×”×¦×œ×—×”:', result);
            
            // ×•×™×“×•× ×©×”× ×ª×•× ×™× × ×©××¨×•
            await this.loadProducts();
            
            return true;
        } catch (e) {
            console.error('×©×’×™××” ×‘×©××™×¨×” ×œ×©×¨×ª:', e);
            
            if (retryCount < MAX_RETRIES) {
                console.log(`× ×™×¡×™×•×Ÿ ×©××™×¨×” ×—×•×–×¨ ${retryCount + 1} ××ª×•×š ${MAX_RETRIES}`);
                await new Promise(resolve => setTimeout(resolve, 1000));
                return this.saveAllToServer(retryCount + 1);
            }
            
            this.showNotification('âŒ ×©×’×™××” ×‘×©××™×¨×ª ×”××•×¦×¨×™×: ' + e.message, 'error');
            throw e;
        }
    }
    constructor() {
        this.products = {};
        this.categories = {
            "kitchen": "××•×¦×¨×™ ××˜×‘×—",
            "bakery": "×§×•× ×“×™×˜×•×¨×™×™×”",
            "fruits": "×¤×™×¨×•×ª",
            "sushi": "×¡×•×©×™",
            "amar": "×§×•× ×“×™×˜×•×¨×™×™×” ×¢××¨",
            "kitchenProducts": "××˜×‘×— ××•×¡×˜×¤×”",
            "online": "××•× ×œ×™×™×Ÿ",
            "warehouse": "××—×¡×Ÿ",
            "sizes": "××•×¦×¨×™ ×’×“×œ×™×",
            "quantities": "××•×¦×¨×™ ×›××•×ª",
        };
        this.init();
    }

    async init() {
        // Keep backend awake by pinging it
        const API_BASE_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
            ? 'http://localhost:5000' 
            : 'https://nsion-chdash-api.onrender.com';
        try {
            await fetch(`${API_BASE_URL}/api/stats`);
        } catch (error) {
            console.warn('Keep-alive ping failed:', error);
        }

    await this.loadProducts();
    // this.displayProducts(); // Removed: Replaced by updateProductsDisplay
    this.updateStats();
    window.productManager = this;
    }

    // ×¤×•× ×§×¦×™×” ×œ×˜×¢×™× ×ª ××•×¦×¨×™× ×-API
    async loadProducts() {
        try {
            const API_BASE_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
                ? 'http://localhost:5000' 
                : 'https://nsion-chdash-api.onrender.com';

            const response = await fetch(`${API_BASE_URL}/api/products`);
            if (!response.ok) {
                throw new Error('×©×’×™××” ×‘×˜×¢×™× ×ª ××•×¦×¨×™× ××”×©×¨×ª');
            }

            const data = await response.json();
            this.products = data.products || {};
            this.categories = data.categories || {};

            this.updateProductsDisplay();
            this.updateStats();

            console.log('âœ… ××•×¦×¨×™× × ×˜×¢× ×• ×‘×”×¦×œ×—×” ××”×©×¨×ª');
        } catch (error) {
            console.error('×©×’×™××” ×‘×˜×¢×™× ×ª ××•×¦×¨×™×:', error);
            this.showNotification(`âŒ ${error.message}`, 'error');
        }
    }

    // ×¤×•× ×§×¦×™×” ×œ×¢×“×›×•×Ÿ ×ª×¦×•×’×ª ×”××•×¦×¨×™×
    updateProductsDisplay() {
        const container = document.getElementById('products-container');
        if (!container) return;

        container.innerHTML = '';

        Object.entries(this.products).forEach(([code, product]) => {
            const productCard = this.createProductCard(code, product);
            container.appendChild(productCard);
        });
    }

    // ×¤×•× ×§×¦×™×” ×œ×™×¦×™×¨×ª ×›×¨×˜×™×¡ ××•×¦×¨
    createProductCard(code, product) {
        const card = document.createElement('div');
        card.className = 'product-card';
        
        // ×•×™×“×•× ×©×™×© ×œ×¤×—×•×ª ×©× ×œ××•×¦×¨
        const productName = product.name || product.Name || '×œ×œ× ×©×';
        const productType = product.type || 'none';
        
        // ×‘× ×™×™×ª ××™×“×¢ ×¢×œ ×”××•×¦×¨
        let productInfo = `
            <div class="product-header">
                <h3>${productName}</h3>
                <span class="product-code">${code}</span>
            </div>
            <div class="product-details">
                <p><strong>×§×˜×’×•×¨×™×”:</strong> ${this.categories[product.category] || '×œ× ××•×’×“×¨'}</p>
                <p><strong>×¡×•×’:</strong> ${this.getTypeDisplay(productType)}</p>
                <!-- Removed redundant line about base price -->
        `;
        
        // ×”×•×¡×¤×ª ×©× ×—×™×¤×•×© ×× ×§×™×™×
        if (product.searchName) {
            productInfo += `<p><strong>×©× ×œ×—×™×¤×•×©:</strong> <span class="search-name">${product.searchName}</span></p>`;
        }
        
        // ×”×¦×’×ª ×¤×¨×˜×™× ×œ×¤×™ ×¡×•×’ ×”××•×¦×¨
        if (productType === 'quantity') {
            if (product.defaultQuantity) {
                productInfo += `<p><strong>×›××•×ª ×‘×¨×™×¨×ª ××—×“×œ:</strong> ${product.defaultQuantity} ${product.unit || ''}</p>`;
            }
            if (product.predefinedQuantities && product.predefinedQuantities.length > 0) {
                productInfo += `<p><strong>×›××•×™×•×ª ×–××™× ×•×ª:</strong> ${product.predefinedQuantities.join(', ')} ${product.unit || ''}</p>`;
            }
        } else if (productType === 'size' && product.defaultSize) {
            productInfo += `<p><strong>×’×•×“×œ ×‘×¨×™×¨×ª ××—×“×œ:</strong> ${product.defaultSize}</p>`;
        }
        
        // ×”×¦×’×ª ×™×—×™×“×ª ××™×“×” ×œ×›×œ ×¡×•×’×™ ×”××•×¦×¨×™× ×× ×§×™×™××ª
        if (product.unit && productType !== 'quantity') {
            productInfo += `<p><strong>×™×—×™×“×ª ××™×“×”:</strong> ${product.unit}</p>`;
        }
        
        // ×”×¦×’×ª ××—×™×¨×™× - ×ª××™×›×” ×‘×›×œ ×”×¤×•×¨××˜×™×
        if (product.sizes && product.sizes.length > 0) {
            const validSizes = product.sizes.filter(s => s.size && (s.price !== undefined && s.price !== null));
            if (validSizes.length > 0) {
                const pricesDisplay = validSizes.map(s => {
                    const price = s.price === 0 ? '×—×™× ×' : `â‚ª${s.price}`;
                    return `${s.size}: ${price}`;
                }).join(', ');
                productInfo += `<p><strong>×’×“×œ×™× ×•××—×™×¨×™×:</strong> ${pricesDisplay}</p>`;
            }
        } else if (product.price !== undefined && product.price !== null) {
            const price = product.price === 0 ? '×—×™× ×' : `â‚ª${product.price}`;
            productInfo += `<p><strong>××—×™×¨:</strong> ${price}</p>`;
        }
        
        // ×”×¦×’×ª ×™×—×™×“×ª ××™×“×” ×× ×§×™×™××ª
        if (product.unit) {
            productInfo += `<p><strong>×™×—×™×“×ª ××™×“×”:</strong> ${product.unit}</p>`;
        }
        
        // ×”×¦×’×ª ×›××•×ª ×¨×’×™×œ×” ×× ×§×™×™××ª (×œ× defaultQuantity)
        if (product.quantity && !product.defaultQuantity) {
            productInfo += `<p><strong>×›××•×ª:</strong> ${product.quantity}</p>`;
        }
        
        productInfo += `
            </div>
            <div class="product-actions">
                <button onclick="productManager.editProduct('${code}')" class="btn btn-primary">âœï¸ ×¢×¨×™×›×”</button>
                <button onclick="productManager.deleteProductConfirm('${code}')" class="btn btn-danger">ğŸ—‘ï¸ ××—×™×§×”</button>
            </div>
        `;
        
        card.innerHTML = productInfo;
        return card;
    }

    // ×¤×•× ×§×¦×™×” ×œ×”×¦×’×ª ×¡×•×’ ×”××•×¦×¨
    getTypeDisplay(type) {
        const types = {
            'quantity': '×›××•×ª',
            'size': '×’×•×“×œ',
            'none': '×œ×œ× ×›××•×ª/×’×•×“×œ'
        };
        return types[type] || '×œ× ××•×’×“×¨';
    }

    // ×¤×•× ×§×¦×™×” ×œ×¢×“×›×•×Ÿ ×¡×˜×˜×™×¡×˜×™×§×•×ª
    updateStats() {
        const stats = this.calculateStats();
        const statsContainer = document.getElementById('stats-container');

        if (statsContainer) {
            const statItems = statsContainer.querySelectorAll('.stat-item .stat-number');
            if (statItems.length >= 4) {
                statItems[0].textContent = stats.total;
                statItems[1].textContent = stats.sizeType;
                statItems[2].textContent = stats.quantityType;
                statItems[3].textContent = stats.noneType;
            }
        }
    }

    // ×¤×•× ×§×¦×™×” ×œ×—×™×©×•×‘ ×¡×˜×˜×™×¡×˜×™×§×•×ª
    calculateStats() {
        const products = Object.values(this.products);
        return {
            total: products.length,
            sizeType: products.filter(p => p.type === 'size').length,
            quantityType: products.filter(p => p.type === 'quantity').length,
            noneType: products.filter(p => p.type === 'none').length
        };
    }

    // ×¤×•× ×§×¦×™×” ×œ×”×¦×’×ª ×”×•×“×¢×•×ª
    showNotification(message, type = 'info') {
        const container = document.getElementById('notifications-container');
        if (!container) return;

        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;

        container.appendChild(notification);

        setTimeout(() => {
            notification.remove();
        }, 5000);
    }

    // ×¤×•× ×§×¦×™×” ×œ×©××™×¨×ª ××•×¦×¨×™× ×œ×§×•×‘×¥ JSON
    async saveProductsToFile() {
        try {
            // × ×™×™×¦× ××ª ×”×§×•×‘×¥ ×™×©×™×¨×•×ª ×œ×œ× ×ª×œ×•×ª ×‘×©×¨×ª
            const jsonContent = JSON.stringify({ 
                products: this.products, 
                categories: this.categories,
                exportDate: new Date().toISOString(),
                version: '1.0'
            }, null, 2);

            const blob = new Blob([jsonContent], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `products_export_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            this.showNotification('âœ… ××•×¦×¨×™× ×™×•×¦××• ×‘×”×¦×œ×—×”', 'success');

            // × × ×¡×” ×œ×©××•×¨ ×‘×©×¨×ª ×‘×¨×§×¢
            this.saveAllToServer().catch(error => {
                console.warn('×©×’×™××” ×‘×©××™×¨×” ×œ×©×¨×ª ××—×¨×™ ×™×™×¦×•×:', error);
                // ×œ× × ×¦×™×’ ×”×•×“×¢×ª ×©×’×™××” ×œ××©×ª××© ×›×™ ×”×™×™×¦×•× ×”×¦×œ×™×—
            });
        } catch (error) {
            console.error('×©×’×™××” ×‘×©××™×¨×ª ×§×•×‘×¥:', error);
            this.showNotification('âŒ ×©×’×™××” ×‘×™×™×¦×•× ×”×§×•×‘×¥: ' + error.message, 'error');
        }
    }

    // ×¤×•× ×§×¦×™×” ×œ×¨×¢× ×•×Ÿ ×”××•×¦×¨×™×
    async refreshProducts() {
        this.showNotification('ğŸ”„ ××¨×¢× ×Ÿ ××•×¦×¨×™×...', 'info');
        await this.loadProducts();
    }

    // ×¤×•× ×§×¦×™×” ×œ×™×™×‘×•× ××•×¦×¨×™×
    async importProducts() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                this.loadProductsFromFile(file);
            }
        };
        input.click();
    }

    // ×¤×•× ×§×¦×™×” ×œ×˜×¢×™× ×ª ××•×¦×¨×™× ××§×•×‘×¥
    async loadProductsFromFile(file) {
        try {
            const text = await file.text();
            const data = JSON.parse(text);

            if (!data.products) {
                throw new Error('×§×•×‘×¥ ×œ× ×ª×§×™×Ÿ - ×—×¡×¨×™× ××•×¦×¨×™×');
            }

            const API_BASE_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
                ? 'http://localhost:5000' 
                : 'https://nsion-chdash-api.onrender.com';

            // ×©×œ×™×—×” ×œ×©×¨×ª ×œ×¢×“×›×•×Ÿ
            const response = await fetch(`${API_BASE_URL}/api/products/import`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || '×©×’×™××” ×‘×©×œ×™×—×” ×œ×©×¨×ª');
            }

            // ×¢×“×›×•×Ÿ ×”× ×ª×•× ×™× ×”××§×•××™×™×
            this.products = data.products;
            if (data.categories) {
                this.categories = { ...this.categories, ...data.categories };
            }

            // ×©××™×¨×ª ×”×›×œ ×‘×©×¨×ª
            await this.saveAllToServer();

            // ×¢×“×›×•×Ÿ ×”×ª×¦×•×’×”
            this.updateProductsDisplay();
            this.updateStats();
            
            this.showNotification('âœ… ××•×¦×¨×™× ×™×•×‘××• ×‘×”×¦×œ×—×”', 'success');
        } catch (error) {
            console.error('×©×’×™××” ×‘×™×™×‘×•×:', error);
            this.showNotification('âŒ ×©×’×™××” ×‘×™×™×‘×•× ×”×§×•×‘×¥: ' + error.message, 'error');
        }
    }

    // ×¤×•× ×§×¦×™×” ×œ×™×™×¦×•× ××•×¦×¨×™×
    exportProducts() {
        this.saveProductsToFile();
    }

    // ×¤×•× ×§×¦×™×” ×œ×™×¦×™×¨×ª ×’×™×‘×•×™
    async backupProducts() {
        try {
            const API_BASE_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
                ? 'http://localhost:5000' 
                : 'https://nsion-chdash-api.onrender.com';

            // ×§×•×“× × ×•×•×“× ×©×”×›×œ ××¢×•×“×›×Ÿ ×‘×©×¨×ª
            await this.saveAllToServer();

            // ×™×¦×™×¨×ª ×§×•×‘×¥ ×’×™×‘×•×™
            const backupData = {
                products: this.products,
                categories: this.categories,
                backupDate: new Date().toISOString(),
                version: '1.0'
            };

            const jsonContent = JSON.stringify(backupData, null, 2);
            const blob = new Blob([jsonContent], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `products_backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);

            this.showNotification('âœ… ×’×™×‘×•×™ × ×•×¦×¨ ×‘×”×¦×œ×—×”', 'success');
        } catch (error) {
            console.error('×©×’×™××” ×‘×™×¦×™×¨×ª ×’×™×‘×•×™:', error);
            this.showNotification('âŒ ×©×’×™××” ×‘×™×¦×™×¨×ª ×’×™×‘×•×™: ' + error.message, 'error');
        }
    }

    searchProducts(query) {
        if (!query.trim()) {
            this.displayProducts();
            return;
        }

        const filteredProducts = {};
        Object.entries(this.products).forEach(([code, product]) => {
            const name = product.name || '';
            const searchName = product.searchName || '';
            if (
                name.toLowerCase().includes(query.toLowerCase()) ||
                code.includes(query) ||
                searchName.toLowerCase().includes(query.toLowerCase())
            ) {
                filteredProducts[code] = product;
            }
        });

        this.displayProducts(filteredProducts);
    }

    displayProducts(productsToDisplay = null) {
        // This function is largely replaced by updateProductsDisplay, but kept for backward compatibility if needed.
        // It's recommended to use updateProductsDisplay directly.
        const container = document.getElementById('products-container');
        if (!container) return;

        const productsToShow = productsToDisplay || this.products;
        const productsArray = Object.entries(productsToShow);

        if (productsArray.length === 0) {
            container.innerHTML = '<p class="no-products">××™×Ÿ ××•×¦×¨×™× ×œ×”×¦×’×”</p>';
            return;
        }

        // ×”×¦×’×ª ×›×¨×˜×™×¡×™ ××•×¦×¨×™× ×›-HTML ×•×œ× ×›××•×‘×™×™×§×˜×™×
        container.innerHTML = productsArray
            .map(([code, product]) => {
                const card = this.createProductCard(code, product);
                return card.outerHTML || card; // ×× ×–×” DOM, × ×™×§×— ××ª ×”-outerHTML, ××—×¨×ª × × ×™×— ×©×–×” ××—×¨×•×–×ª
            })
            .join('');
    }

    openAddProductModal() {
        document.getElementById('productForm').reset();
        document.getElementById('editMode').value = 'false';
        document.getElementById('productCode').value = '';
        document.getElementById('productQuantity').value = '';
        this.resetSizeInputs();
        const modalTitle = document.getElementById('modal-title');
        if (modalTitle) {
            modalTitle.textContent = '×”×•×¡×¤×ª ××•×¦×¨ ×—×“×©';
        }
        const sizesSection = document.getElementById('sizes-section');
        if (sizesSection) {
            sizesSection.style.display = 'block';
        }
        document.getElementById('productModal').style.display = 'block';
    }

    editProduct(code) {
        const product = this.products[code];
        if (!product) {
            this.showNotification('âŒ ××•×¦×¨ ×œ× × ××¦×', 'error');
            return;
        }

        // ×•×™×“×•× ×©×™×© ×©× ×œ××•×¦×¨
        const productName = product.name || product.Name || '×œ×œ× ×©×';
        const productType = product.type || 'none';

        const modalTitle = document.getElementById('modal-title');
        if (modalTitle) {
            modalTitle.textContent = `×¢×¨×™×›×ª ××•×¦×¨: ${productName}`;
        }

    document.getElementById('editMode').value = 'true';
    const codeInput = document.getElementById('productCode');
    codeInput.value = code;
    codeInput.removeAttribute('disabled'); // ×•×“× ×©×”×©×“×” ×œ× × ×¢×•×œ ×œ×¢×¨×™×›×”
    this.lastEditedProductCode = code; // ×©××•×¨ ××ª ×”×§×•×“ ×”××§×•×¨×™ ×œ×¢×¨×™×›×”
        document.getElementById('productName').value = productName;
        document.getElementById('productCategory').value = product.category || '';
        document.getElementById('searchName').value = product.searchName || '';
        document.getElementById('productType').value = productType;
        
        // ×˜×¢×™× ×ª × ×ª×•× ×™× ×¡×¤×¦×™×¤×™×™× ×œ×¤×™ ×¡×•×’ ×”××•×¦×¨
        if (productType === 'quantity') {
            document.getElementById('productQuantity').value = product.defaultQuantity || '';
            const unitSelect = document.getElementById('unitType');
            if (unitSelect && product.unit) {
                // ×ª××™×›×” ×‘×›×œ ×™×—×™×“×•×ª ×”××™×“×” ×”×§×™×™××•×ª
                if (unitSelect.querySelector(`option[value="${product.unit}"]`)) {
                    unitSelect.value = product.unit;
                } else {
                    // ×”×•×¡×¤×ª ×™×—×™×“×ª ××™×“×” ×—×“×©×” ×× ×œ× ×§×™×™××ª ×‘×¨×©×™××”
                    const newOption = document.createElement('option');
                    newOption.value = product.unit;
                    newOption.textContent = product.unit;
                    unitSelect.appendChild(newOption);
                    unitSelect.value = product.unit;
                }
            }
        } else {
            // ×¢×‘×•×¨ ××•×¦×¨×™× ××—×¨×™× - × ×‘×“×•×§ ×× ×™×© ×›××•×ª ×¨×’×™×œ×”
            document.getElementById('productQuantity').value = product.quantity || product.defaultQuantity || '';
            
            // ×˜×¢×™× ×ª ×™×—×™×“×ª ××™×“×” ×’× ×œ××•×¦×¨×™× ×©××™× × ××¡×•×’ quantity
            const unitSelect = document.getElementById('unitType');
            if (unitSelect && product.unit) {
                if (unitSelect.querySelector(`option[value="${product.unit}"]`)) {
                    unitSelect.value = product.unit;
                } else {
                    const newOption = document.createElement('option');
                    newOption.value = product.unit;
                    newOption.textContent = product.unit;
                    unitSelect.appendChild(newOption);
                    unitSelect.value = product.unit;
                }
            }
        }
        
        // ×˜×¢×™× ×ª ××—×™×¨ ×‘×¡×™×¡×™

        this.toggleQuantityFields();

        // ×˜×¢×™× ×ª ×’×“×œ×™× ×•××—×™×¨×™× ×× ×§×™×™××™×
        if (product.sizes && product.sizes.length > 0) {
            this.loadProductSizes(product.sizes);
            const sizesSection = document.getElementById('sizes-section');
            if (sizesSection) {
                sizesSection.style.display = 'block';
            }
        } else {
            this.resetSizeInputs();
        }

        document.getElementById('productModal').style.display = 'block';
    }

    loadProductSizes(sizes) {
        const sizesContainer = document.getElementById('sizes-container');
        if (!sizesContainer) return;

        sizesContainer.innerHTML = '';

        // ×•×™×“×•× ×©sizes ×”×•× ××¢×¨×š
        const sizesArray = Array.isArray(sizes) ? sizes : [];
        
        sizesArray.forEach((sizeData) => {
            if (sizeData && (sizeData.size || sizeData.Size)) {
                const sizeRow = this.createSizeRow();
                const sizeInput = sizeRow.querySelector('.size-input');
                const priceInput = sizeRow.querySelector('.price-input');

                sizeInput.value = sizeData.size || sizeData.Size || '';
                priceInput.value = (sizeData.price !== undefined && sizeData.price !== null) ? sizeData.price : '';

                sizesContainer.appendChild(sizeRow);
            }
        });
        
        // ×× ××™×Ÿ ×’×“×œ×™×, × ×•×¡×™×£ ×©×•×¨×” ×¨×™×§×” ××—×ª ×œ× ×•×—×•×ª
        if (sizesArray.length === 0) {
            this.addSizeRow();
        }
    }

    createSizeRow() {
        const sizeRow = document.createElement('div');
        sizeRow.className = 'size-row';
        sizeRow.innerHTML = `
            <input type="text" class="size-input" placeholder="×’×•×“×œ/×›××•×ª" required>
            <input type="number" class="price-input" placeholder="××—×™×¨" step="0.01" required>
            <button type="button" class="btn btn-remove" onclick="productManager.removeSize(this)">×”×¡×¨</button>
        `;
        return sizeRow;
    }

    addSizeRow() {
        const sizesContainer = document.getElementById('sizes-container');
        if (!sizesContainer) return;

        const sizeRow = this.createSizeRow();
        sizesContainer.appendChild(sizeRow);
    }

    removeSize(button) {
        const sizeRow = button.closest('.size-row');
        if (sizeRow) {
            sizeRow.remove();
        }
    }

    toggleQuantityFields() {
        const productType = document.getElementById('productType').value;
        const quantityFields = document.getElementById('quantity-fields');
        const sizeFields = document.getElementById('size-fields');
        const basePriceField = document.getElementById('base-price-field');
        const sizesSection = document.getElementById('sizes-section');

        // ×”×¡×ª×¨×ª ×›×œ ×”×©×“×•×ª ×ª×—×™×œ×”
        if (quantityFields) quantityFields.style.display = 'none';
        if (sizeFields) sizeFields.style.display = 'none';
        if (basePriceField) basePriceField.style.display = 'none';
        if (sizesSection) sizesSection.style.display = 'none';

        // ×”×¦×’×ª ×©×“×•×ª ×œ×¤×™ ×¡×•×’ ×”××•×¦×¨
        if (productType === 'quantity') {
            // ××•×¦×¨×™ ×›××•×ª - ××¦×™×’×™× ×©×“×” ×›××•×ª + ×™×—×™×“×ª ××™×“×” + ×˜×‘×œ×ª ××—×™×¨×™×
            if (quantityFields) quantityFields.style.display = 'block';
            if (sizesSection) sizesSection.style.display = 'block';
        } else if (productType === 'size') {
            // ××•×¦×¨×™ ×’×•×“×œ - ×˜×‘×œ×ª ×’×“×œ×™× ×•××—×™×¨×™× + ×™×—×™×“×ª ××™×“×” (××•×¤×¦×™×•× ×œ×™)
            if (quantityFields) quantityFields.style.display = 'block'; // ××¦×™×’ ×’× ×™×—×™×“×ª ××™×“×”
            if (sizesSection) sizesSection.style.display = 'block';
        } else if (productType === 'none') {
            // ××•×¦×¨×™× ×œ×œ× ×›××•×ª/×’×•×“×œ - ×™×›×•×œ×™× ×œ×”×™×•×ª ×¢× ××• ×‘×œ×™ ××—×™×¨ + ×™×—×™×“×ª ××™×“×”
            if (quantityFields) quantityFields.style.display = 'block'; // ××¦×™×’ ×’× ×™×—×™×“×ª ××™×“×”
            if (sizesSection) sizesSection.style.display = 'block';
            if (basePriceField) basePriceField.style.display = 'block';
        }
    }

    async saveProduct() {
    try {
            const form = document.getElementById('productForm');
            const formData = new FormData(form);

            const productData = {
                name: formData.get('productName'),
                category: formData.get('productCategory'),
                searchName: formData.get('searchName'),
                type: formData.get('productType'),
                sizes: []
            };
            
            // ×•×™×“×•× ×©×“×•×ª ×—×•×‘×”
            if (!productData.name || !productData.category) {
                this.showNotification('âŒ ×™×© ×œ××œ× ×©× ×•×§×˜×’×•×¨×™×”', 'error');
                return;
            }

            const API_BASE_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
                ? 'http://localhost:5000'
                : 'https://nsaion-golsya.netlify.app';

            // ×”×•×¡×¤×ª × ×ª×•× ×™× ×¡×¤×¦×™×¤×™×™× ×œ×¤×™ ×¡×•×’ ×”××•×¦×¨
            const quantity = formData.get('productQuantity');
            
            // ×”×•×¡×¤×ª ×™×—×™×“×ª ××™×“×” ×œ×›×œ ×¡×•×’×™ ×”××•×¦×¨×™×
            const unitType = document.getElementById('unitType');
            if (unitType && unitType.value) {
                productData.unit = unitType.value;
            }
            
            if (productData.type === 'quantity') {
                if (quantity) {
                    productData.defaultQuantity = parseInt(quantity);
                    productData.predefinedQuantities = productData.predefinedQuantities || [];
                    if (!productData.predefinedQuantities.includes(parseInt(quantity))) {
                        productData.predefinedQuantities.push(parseInt(quantity));
                    }
                }
            } else if (productData.type === 'size') {
                const defaultSize = document.getElementById('defaultSize');
                if (defaultSize && defaultSize.value) {
                    productData.defaultSize = defaultSize.value;
                }
                if (quantity) {
                    productData.quantity = quantity;
                }
            } else {
                if (quantity) {
                    productData.quantity = quantity;
                }
            }

            // ××™×¡×•×£ × ×ª×•× ×™ ××—×™×¨×™× ×•×’×“×œ×™×
            const sizeRows = document.querySelectorAll('.size-row');
            sizeRows.forEach(row => {
                const sizeInput = row.querySelector('.size-input');
                const priceInput = row.querySelector('.price-input');

                if (sizeInput && sizeInput.value.trim()) {
                    const price = priceInput && priceInput.value.trim() ? parseFloat(priceInput.value) : 0;
                    productData.sizes.push({
                        size: sizeInput.value.trim(),
                        price: price
                    });
                }
            });

            // ×•×™×“×•× ×ª×§×™× ×•×ª ×œ×¤×™ ×¡×•×’ ×”××•×¦×¨
            if (productData.type === 'size' && productData.sizes.length === 0) {
                this.showNotification('âŒ ××•×¦×¨ ××¡×•×’ "×’×•×“×œ" ×—×™×™×‘ ×œ×›×œ×•×œ ×œ×¤×—×•×ª ×’×•×“×œ ××—×“', 'error');
                return;
            }

            const isEdit = formData.get('editMode') === 'true';
            let productCode = formData.get('productCode');

            const API_BASE_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
                ? 'http://localhost:5000' 
                : 'https://nsion-chdash-api.onrender.com';

            if (!isEdit) {
                if (!productCode || productCode.trim() === '') {
                    productCode = this.generateProductCode();
                }
                if (this.products[productCode]) {
                    this.showNotification('âŒ ×§×•×“ ××•×¦×¨ ×›×‘×¨ ×§×™×™×', 'error');
                    return;
                }
            }

            // × ×™×¡×™×•×Ÿ ×©××™×¨×” ×œ×©×¨×ª
            let response;
            if (isEdit && this.lastEditedProductCode && this.lastEditedProductCode !== productCode) {
                // ××—×™×§×ª ×”××•×¦×¨ ×”×™×©×Ÿ
                await fetch(`${API_BASE_URL}/api/products/${this.lastEditedProductCode}`, { method: 'DELETE' });
                
                // ×¢×“×›×•×Ÿ ××• ×™×¦×™×¨×ª ××•×¦×¨ ×—×“×©
                response = await fetch(
                    this.products[productCode] 
                        ? `${API_BASE_URL}/api/products/${productCode}`
                        : `${API_BASE_URL}/api/products`,
                    {
                        method: this.products[productCode] ? 'PUT' : 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ...productData, code: productCode })
                    }
                );
            } else {
                response = await fetch(
                    isEdit 
                        ? `${API_BASE_URL}/api/products/${productCode}`
                        : `${API_BASE_URL}/api/products`,
                    {
                        method: isEdit ? 'PUT' : 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ...productData, code: productCode })
                    }
                );
            }

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || '×©×’×™××” ×‘×©××™×¨×ª ×”××•×¦×¨');
            }

            const result = await response.json();
            
            // ×¢×“×›×•×Ÿ ×”××•×¦×¨ ×‘××¢×¨×›×ª
            this.products[productCode] = { ...productData, code: productCode };
            if (isEdit && this.lastEditedProductCode && this.lastEditedProductCode !== productCode) {
                delete this.products[this.lastEditedProductCode];
            }

            // ×©××™×¨×” ××™×™×“×™×ª ×©×œ ×›×œ ×”×©×™× ×•×™×™× ×œ×©×¨×ª
            await this.saveAllToServer();
            
            // ×¢×“×›×•×Ÿ ×”×ª×¦×•×’×”
            this.displayProducts();
            this.updateStats();
            this.closeProductModal();
            
            this.showNotification(isEdit ? 'âœ… ××•×¦×¨ ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”' : 'âœ… ××•×¦×¨ × ×•×¡×£ ×‘×”×¦×œ×—×”', 'success');

        } catch (error) {
            console.error('×©×’×™××” ×‘×©××™×¨×ª ××•×¦×¨:', error);
            this.showNotification(`âŒ ${error.message}`, 'error');
        }
    }


    // Function to confirm deletion before performing it
    async deleteProductConfirm(code) {
        const product = this.products[code];
        if (!product) {
            this.showNotification('âŒ ××•×¦×¨ ×œ× × ××¦×', 'error');
            return;
        }

        const confirmDelete = confirm(`×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”××•×¦×¨ "${product.name}" (${code})?`);

        if (confirmDelete) {
            await this.deleteProduct(code);
        }
    }

    // Function to actually delete the product (API call)
    async deleteProduct(code) {
    try {
            const API_BASE_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
                ? 'http://localhost:5000' 
                : 'https://nsion-chdash-api.onrender.com';

            const response = await fetch(`${API_BASE_URL}/api/products/${code}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                const result = await response.json();
                const message = result.message || `âœ… ××•×¦×¨ "${this.products[code]?.name || code}" × ××—×§ ×‘×”×¦×œ×—×”`;
                this.showNotification(message, 'success');
                delete this.products[code];
                await this.saveAllToServer();
                this.displayProducts();
                this.updateStats();
            } else {
                const errorText = await response.text();
                let errorMessage = '×©×’×™××” ×‘××—×™×§×ª ××•×¦×¨ ××”×©×¨×ª';
                try {
                    const errorData = JSON.parse(errorText);
                    errorMessage = errorData.message || errorMessage;
                } catch {
                    errorMessage = errorText || errorMessage;
                }
                throw new Error(errorMessage);
            }
        } catch (error) {
            console.error('×©×’×™××” ×‘××—×™×§×ª ××•×¦×¨:', error);
            this.showNotification(`âŒ ${error.message}`, 'error');
        }
    }

    closeProductModal() {
        document.getElementById('productModal').style.display = 'none';
        document.getElementById('productForm').reset();
        const modalTitle = document.getElementById('modal-title');
        if (modalTitle) {
            modalTitle.textContent = '×”×•×¡×¤×ª ××•×¦×¨ ×—×“×©';
        }
        this.resetSizeInputs();
        const quantityFields = document.getElementById('quantity-fields');
        const sizeFields = document.getElementById('size-fields');
        const sizesSection = document.getElementById('sizes-section');

        if (quantityFields) quantityFields.style.display = 'none';
        if (sizeFields) sizeFields.style.display = 'none';
        if (sizesSection) sizesSection.style.display = 'none';
    }

    closeDeleteModal() {
        // Assuming there's a modal for confirmation, if not, this does nothing.
        // If a modal exists with id 'delete-modal', its display should be set to 'none'.
        const deleteModal = document.getElementById('delete-modal');
        if (deleteModal) {
            deleteModal.style.display = 'none';
        }
    }

    confirmDelete() {
        const deleteModal = document.getElementById('delete-modal');
        const productCode = deleteModal.dataset.productCode;

        if (productCode) {
            this.deleteProduct(productCode);
            this.closeDeleteModal();
        }
    }

    resetSizeInputs() {
        const sizesContainer = document.getElementById('sizes-container');
        if (sizesContainer) {
            sizesContainer.innerHTML = '';
        }
    }

    // generateProductCode() and isProductCodeExists() are likely not needed if API handles code generation
    // Keeping them commented out for now, but they might be useful for fallback or specific client-side logic.
    generateProductCode() {
        let code = 10000;
        while (this.products[code.toString()]) {
            // ×©××™×¨×” ×××™×ª×™×ª ×œ×©×¨×ª
            this.saveAllToServer();
            this.showNotification('âœ… ×›×œ ×”××•×¦×¨×™× × ×©××¨×• ×‘×§×•×‘×¥ ×‘×”×¦×œ×—×”', 'success');
        }
        const productForm = document.getElementById('productForm');
        if (productForm) {
            productForm.addEventListener('submit', (e) => {
                e.preventDefault();
                this.saveProduct();
            });
        }

        const typeSelect = document.getElementById('productType');
        if (typeSelect) {
            typeSelect.addEventListener('change', () => this.toggleQuantityFields());
            this.toggleQuantityFields(); // Initial call
        }
    }
}

// Global functions
function openAddProductModal() {
    if (window.productManager) {
        window.productManager.openAddProductModal();
    }
}

function closeProductModal() {
    if (window.productManager) {
        window.productManager.closeProductModal();
    }
}

function addSizeRow() {
    if (window.productManager) {
        window.productManager.addSizeRow();
    }
}

function removeSize(button) {
    if (window.productManager) {
        window.productManager.removeSize(button);
    }
}

function deleteProductConfirm(code) { // Renamed from deleteProduct for clarity
    if (window.productManager) {
        window.productManager.deleteProductConfirm(code);
    }
}

function searchProducts(query) {
    if (window.productManager) {
        window.productManager.searchProducts(query);
    }
}

function backupProducts() {
    if (window.productManager) {
        window.productManager.backupProducts();
    }
}

function exportProducts() {
    if (window.productManager) {
        window.productManager.exportProducts();
    }
}

function importProducts() {
    if (window.productManager) {
        window.productManager.importProducts();
    }
}

function refreshProducts() {
    if (window.productManager) {
        window.productManager.refreshProducts();
    }
}

document.addEventListener('DOMContentLoaded', () => {
    new ProductManager();
    // ×”×¤×¢×œ×ª ×—×™×¤×•×© ×“×™× ××™ ×‘×©×“×” ×”×—×™×¤×•×©
    const searchInput = document.getElementById('search-input');
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            if (window.productManager) {
                window.productManager.searchProducts(e.target.value);
            }
        });
    }
});